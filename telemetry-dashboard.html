<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MFE Telemetry Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 2px solid #1e293b;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    .health-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .health-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      border: 2px solid #334155;
      transition: all 0.3s ease;
    }

    .health-card:hover {
      border-color: #60a5fa;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(96, 165, 250, 0.2);
    }

    .health-card.healthy { border-left: 4px solid #10b981; }
    .health-card.degraded { border-left: 4px solid #f59e0b; }
    .health-card.critical { border-left: 4px solid #ef4444; }

    .health-card h3 {
      font-size: 14px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .health-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .health-label {
      font-size: 12px;
      color: #64748b;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }

    .status-badge.healthy {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge.degraded {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-badge.critical {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .mfe-instances {
      margin-bottom: 30px;
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #334155;
    }

    .instance-grid {
      display: grid;
      gap: 20px;
    }

    .instance-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      border: 2px solid #334155;
    }

    .instance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .instance-name {
      font-size: 18px;
      font-weight: 600;
    }

    .instance-id {
      font-size: 11px;
      color: #64748b;
      font-family: 'Courier New', monospace;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metric {
      background: #0f172a;
      border-radius: 8px;
      padding: 16px;
    }

    .metric-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 600;
    }

    .metric-value.good { color: #10b981; }
    .metric-value.warn { color: #f59e0b; }
    .metric-value.bad { color: #ef4444; }

    .metric-sublabel {
      font-size: 10px;
      color: #64748b;
      margin-top: 4px;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
    }

    button {
      background: #60a5fa;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    button:hover {
      background: #3b82f6;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(96, 165, 250, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #1e293b;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    button.secondary:hover {
      background: #334155;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .no-data-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .updating {
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MFE Telemetry Dashboard</h1>
      <p class="subtitle">Real-time health monitoring based on destructive testing thresholds</p>
    </header>

    <div class="health-overview" id="health-overview">
      <!-- Health cards will be dynamically inserted here -->
    </div>

    <div class="mfe-instances">
      <h2 class="section-header">Active MFE Instances</h2>
      <div class="instance-grid" id="instance-grid">
        <!-- Instance cards will be dynamically inserted here -->
      </div>
    </div>

    <div class="controls">
      <button class="secondary" onclick="exportAllMetrics()">Export Metrics</button>
      <button onclick="refreshDashboard()">Refresh</button>
    </div>
  </div>

  <script>
    // Access global telemetry registry
    function getTelemetryRegistry() {
      return window.__MFE_TELEMETRY__ || window.parent.__MFE_TELEMETRY__;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDuration(ms) {
      if (ms < 1000) return ms.toFixed(2) + 'ms';
      return (ms / 1000).toFixed(2) + 's';
    }

    function formatPercent(decimal) {
      return (decimal * 100).toFixed(2) + '%';
    }

    function getStatusClass(status) {
      if (status === 'healthy') return 'healthy';
      if (status === 'degraded') return 'degraded';
      return 'critical';
    }

    function getMetricClass(value, thresholds) {
      if (value <= thresholds.normal) return 'good';
      if (value <= thresholds.warning) return 'warn';
      return 'bad';
    }

    function renderHealthOverview(registry) {
      const overallHealth = registry.getOverallHealth();
      const allHealthChecks = registry.getAllHealthChecks();

      // Calculate aggregate stats
      const totalErrors = allHealthChecks.reduce((sum, h) => sum + h.checks.errors.totalErrors, 0);
      const totalOps = allHealthChecks.reduce((sum, h) => sum + h.checks.errors.totalOperations, 0);
      const avgErrorRate = totalOps > 0 ? totalErrors / totalOps : 0;

      const avgMountTime = allHealthChecks.length > 0
        ? allHealthChecks.reduce((sum, h) => sum + h.checks.performance.avgMountTime, 0) / allHealthChecks.length
        : 0;

      const avgMemoryPerCycle = allHealthChecks.length > 0
        ? allHealthChecks.reduce((sum, h) => sum + h.checks.memory.current, 0) / allHealthChecks.length
        : 0;

      const html = `
        <div class="health-card ${getStatusClass(overallHealth)}">
          <h3>Overall Health</h3>
          <div class="health-value">${allHealthChecks.length}</div>
          <div class="health-label">Active Instances</div>
          <div class="status-badge ${getStatusClass(overallHealth)}">${overallHealth}</div>
        </div>

        <div class="health-card ${getMetricClass(avgErrorRate, { normal: 0.01, warning: 0.05 })}">
          <h3>Error Rate</h3>
          <div class="health-value">${formatPercent(avgErrorRate)}</div>
          <div class="health-label">${totalErrors} / ${totalOps} operations</div>
          <div class="status-badge ${getMetricClass(avgErrorRate, { normal: 0.01, warning: 0.05 })}">
            ${avgErrorRate <= 0.01 ? 'healthy' : avgErrorRate <= 0.05 ? 'degraded' : 'critical'}
          </div>
        </div>

        <div class="health-card ${getMetricClass(avgMountTime, { normal: 100, warning: 200 })}">
          <h3>Avg Mount Time</h3>
          <div class="health-value">${avgMountTime.toFixed(0)}<span style="font-size: 16px;">ms</span></div>
          <div class="health-label">Target: <100ms</div>
          <div class="status-badge ${getMetricClass(avgMountTime, { normal: 100, warning: 200 })}">
            ${avgMountTime <= 100 ? 'healthy' : avgMountTime <= 200 ? 'degraded' : 'critical'}
          </div>
        </div>

        <div class="health-card ${getMetricClass(avgMemoryPerCycle, { normal: 750 * 1024, warning: 1024 * 1024 })}">
          <h3>Avg Memory/Cycle</h3>
          <div class="health-value">${formatBytes(avgMemoryPerCycle)}</div>
          <div class="health-label">Target: <750KB</div>
          <div class="status-badge ${getMetricClass(avgMemoryPerCycle, { normal: 750 * 1024, warning: 1024 * 1024 })}">
            ${avgMemoryPerCycle <= 750 * 1024 ? 'healthy' : avgMemoryPerCycle <= 1024 * 1024 ? 'degraded' : 'critical'}
          </div>
        </div>
      `;

      document.getElementById('health-overview').innerHTML = html;
    }

    function renderInstances(registry) {
      const telemetryInstances = registry.getAll();

      if (telemetryInstances.length === 0) {
        document.getElementById('instance-grid').innerHTML = `
          <div class="no-data">
            <div class="no-data-icon">üìä</div>
            <h3>No Active MFE Instances</h3>
            <p>Mount an MFE to start collecting telemetry</p>
          </div>
        `;
        return;
      }

      const html = telemetryInstances.map(telemetry => {
        const summary = telemetry.getSummary();
        const health = summary.health;

        return `
          <div class="instance-card">
            <div class="instance-header">
              <div>
                <div class="instance-name">${summary.mfeName}</div>
                <div class="instance-id">${summary.instanceId}</div>
              </div>
              <div class="status-badge ${getStatusClass(summary.status)}">${summary.status}</div>
            </div>

            <div class="metrics-grid">
              <div class="metric">
                <div class="metric-label">Uptime</div>
                <div class="metric-value">${formatDuration(summary.uptime)}</div>
                <div class="metric-sublabel">${summary.cycles} cycles</div>
              </div>

              <div class="metric">
                <div class="metric-label">Mount Time</div>
                <div class="metric-value ${getMetricClass(summary.performance.avgMountTime, { normal: 100, warning: 200 })}">
                  ${summary.performance.avgMountTime.toFixed(0)}ms
                </div>
                <div class="metric-sublabel">Last: ${summary.performance.lastMountTime.toFixed(0)}ms</div>
              </div>

              <div class="metric">
                <div class="metric-label">Unmount Time</div>
                <div class="metric-value ${getMetricClass(summary.performance.avgUnmountTime, { normal: 50, warning: 100 })}">
                  ${summary.performance.avgUnmountTime.toFixed(0)}ms
                </div>
                <div class="metric-sublabel">Last: ${summary.performance.lastUnmountTime.toFixed(0)}ms</div>
              </div>

              <div class="metric">
                <div class="metric-label">Error Rate</div>
                <div class="metric-value ${getMetricClass(summary.errorRate, { normal: 0.01, warning: 0.05 })}">
                  ${formatPercent(summary.errorRate)}
                </div>
                <div class="metric-sublabel">${summary.errors} / ${summary.operations}</div>
              </div>

              <div class="metric">
                <div class="metric-label">Memory Growth</div>
                <div class="metric-value ${getMetricClass(summary.memory.growth, { normal: 0, warning: 5 * 1024 * 1024 })}">
                  ${formatBytes(summary.memory.growth)}
                </div>
                <div class="metric-sublabel">Peak: ${formatBytes(summary.memory.peak)}</div>
              </div>

              <div class="metric">
                <div class="metric-label">Memory/Cycle</div>
                <div class="metric-value ${getMetricClass(summary.memory.perCycle, { normal: 750 * 1024, warning: 1024 * 1024 })}">
                  ${formatBytes(summary.memory.perCycle)}
                </div>
                <div class="metric-sublabel">${health.checks.memory.message}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('instance-grid').innerHTML = html;
    }

    function refreshDashboard() {
      const registry = getTelemetryRegistry();

      if (!registry) {
        document.getElementById('health-overview').innerHTML = `
          <div class="no-data">
            <div class="no-data-icon">‚ö†Ô∏è</div>
            <h3>Telemetry Registry Not Found</h3>
            <p>Make sure MFEs are loaded with telemetry enabled</p>
          </div>
        `;
        document.getElementById('instance-grid').innerHTML = '';
        return;
      }

      renderHealthOverview(registry);
      renderInstances(registry);
    }

    function exportAllMetrics() {
      const registry = getTelemetryRegistry();
      if (!registry) {
        alert('No telemetry data available');
        return;
      }

      const allMetrics = registry.getAll().map(t => t.getSummary());
      const json = JSON.stringify({
        timestamp: new Date().toISOString(),
        overallHealth: registry.getOverallHealth(),
        instances: allMetrics
      }, null, 2);

      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mfe-telemetry-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Auto-refresh every 2 seconds
    setInterval(refreshDashboard, 2000);

    // Initial load
    refreshDashboard();
  </script>
</body>
</html>
